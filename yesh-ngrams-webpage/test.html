<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orangutype â€¢ Test</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="corpora.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1 class="app-title">ORANGUTYPE</h1>
        </div>

        <div class="main-content">
            <div class="text-area" id="textArea">
                <div class="text-content" id="textContent"></div>
            </div>

            <div class="modal" id="testCompleteModal" style="display: none;">
                <div class="modal-content">
                    <h2 class="modal-title">TEST COMPLETE!</h2>
                    <div class="results-grid">
                        <div class="result-column">
                            <div class="result-item">
                                <span class="result-label">WPM</span>
                                <span class="result-value" id="resultWpm">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">ACCURACY</span>
                                <span class="result-value" id="resultAccuracy">0%</span>
                            </div>
                        </div>
                        <div class="result-column">
                            <div class="result-item">
                                <span class="result-label">TIME ELAPSED:</span>
                                <span class="result-value" id="resultTime">0:00</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">WORDS TYPED:</span>
                                <span class="result-value" id="resultWords">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instructions">TAB + ENTER - RESTART TEST</div>
        </div>

        <div class="footer">
            <div class="control-row">
                <div class="time-remaining">
                    <span class="label">TIME REMAINING:</span>
                    <span class="time-value" id="timeRemaining">1:00</span>
                </div>
                <div class="language-selector">
                    <div class="language-icon">Aa</div>
                    <span class="language-text">ENGLISH</span>
                </div>
            </div>
            <div class="control-row">
                <div class="feature-toggles">
                    <span class="toggle-item"># PUNCTUATIONS</span>
                    <span class="toggle-item">$ NUMBERS</span>
                </div>
                <div class="separator"></div>
                <div class="time-options">
                    <span class="time-option" data-duration="15">15</span>
                    <span class="time-option" data-duration="30">30</span>
                    <span class="time-option" data-duration="60">60</span>
                    <span class="time-option" data-duration="120">120</span>
                </div>
                <div class="separator"></div>
                <div class="action-buttons">
                    <button class="action-btn" id="newTestBtn">NEW TEST</button>
                    <button class="action-btn" id="restartBtn">RESTART</button>
                    <button class="action-btn back-btn" id="backBtn">MAIN MENU</button>
                </div>
            </div>
        </div>

        <input type="text" id="hiddenInput" class="hidden-input" autocomplete="off" spellcheck="false">
        <div class="cursor-indicator" id="cursorIndicator"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const search = new URLSearchParams(location.search);
        const difficulty = (search.get('difficulty') || 'medium').toLowerCase();

        const hiddenInput = document.getElementById('hiddenInput');
        const textArea = document.getElementById('textArea');
        const newTestBtn = document.getElementById('newTestBtn');
        const restartBtn = document.getElementById('restartBtn');
        const timeOptions = document.querySelectorAll('.time-option');

        let testActive = false;
        let startTime = null;
        let testDuration = 60;
        let words = [];
        let currentWordIndex = 0;
        let typedWords = [];
        let incorrectWords = [];
        let grossCharsTyped = 0; // for WPM (typed chars)
        let accCorrectChars = 0; // for accuracy numerator
        let accTotalChars = 0;   // for accuracy denominator (correct+incorrect+extra+missed)
        let totalWordsTyped = 0;
        let correctWordsTyped = 0;

        function pickText() {
            const corp = (window.CORPORA && window.CORPORA[difficulty]) || [];
            const pool = corp.length ? corp : (window.CORPORA ? (window.CORPORA.medium || []) : []);
            // Pick up to 4 sentences to preview
            const batch = [];
            for (let i = 0; i < 4; i++) {
                const line = pool[Math.floor(Math.random() * pool.length)];
                if (line) batch.push(line.trim());
            }
            const text = batch.join(' ');
            words = text.split(/\s+/);
            displayText(batch);
        }

        function startTest() {
            if (testActive) return;
            testActive = true;
            startTime = Date.now();
            currentWordIndex = 0;
            typedWords = [];
            incorrectWords = [];
            grossCharsTyped = 0;
            accCorrectChars = 0;
            accTotalChars = 0;
            totalWordsTyped = 0;
            correctWordsTyped = 0;
            pickText();
            hiddenInput.focus();
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);
            const endInterval = setInterval(() => {
                if (Date.now() - startTime >= testDuration * 1000) {
                    clearInterval(timerInterval);
                    clearInterval(endInterval);
                    endTest();
                }
            }, 1000);
        }

        function endTest() {
            testActive = false;
            const elapsed = (Date.now() - startTime) / 1000;
            const minutes = Math.max(1e-6, elapsed / 60);
            const wpm = Math.round((grossCharsTyped / 5) / minutes);
            const accuracy = accTotalChars > 0 ? Math.round((accCorrectChars / accTotalChars) * 100) : 100;
            document.getElementById('resultWpm').textContent = wpm;
            document.getElementById('resultAccuracy').textContent = accuracy + '%';
            document.getElementById('resultTime').textContent = formatTime(elapsed);
            document.getElementById('resultWords').textContent = totalWordsTyped;
            document.getElementById('testCompleteModal').style.display = 'flex';
            document.getElementById('cursorIndicator').style.display = 'none';
        }

        function processWord(word) {
            if (!testActive) return;
            typedWords.push(word);
            const expected = words[currentWordIndex];
            const isCorrect = word === expected;
            const el = document.querySelector(`[data-index="${currentWordIndex}"]`);
            if (el) {
                el.classList.remove('current');
                el.classList.add(isCorrect ? 'correct' : 'incorrect');
            }
            if (!isCorrect) incorrectWords.push({ expected, typed: word, position: currentWordIndex });
            // Stats
            totalWordsTyped += 1;
            grossCharsTyped += word.length; // only what the user typed counts for WPM
            // Character accounting for accuracy (Monkeytype-like)
            const stats = compareWordChars(word, expected);
            accCorrectChars += stats.matches;
            accTotalChars += stats.matches + stats.incorrect + stats.extra + stats.missed;
            if (normalizeWord(word) === normalizeWord(expected)) correctWordsTyped += 1;
            currentWordIndex++;
            updateDisplay();
            if (currentWordIndex >= words.length) {
                pickText();
                currentWordIndex = 0;
                updateDisplay();
            }
        }

        function displayText(sentences) {
            const textContent = document.getElementById('textContent');
            textContent.innerHTML = '';
            let wordCounter = 0;
            const toRender = Array.isArray(sentences) ? sentences.join(' ') : String(sentences);
            const split = toRender.split(/\s+/);
            split.forEach(w => {
                const span = document.createElement('span');
                span.textContent = w + ' ';
                span.className = 'word';
                span.dataset.index = wordCounter++;
                textContent.appendChild(span);
            });
            updateDisplay();
        }

        function updateDisplay() {
            const els = document.querySelectorAll('.word');
            els.forEach((el, i) => {
                const wasCorrect = el.classList.contains('correct');
                const wasIncorrect = el.classList.contains('incorrect');
                el.className = 'word';
                if (i < currentWordIndex) {
                    if (wasCorrect) el.classList.add('correct');
                    else if (wasIncorrect) el.classList.add('incorrect');
                } else if (i === currentWordIndex) {
                    el.classList.add('current');
                }
            });
        }

        function updateCurrentWordDisplay(typedText, expectedWord) {
            if (!expectedWord) return;
            const el = document.querySelector(`[data-index="${currentWordIndex}"]`);
            if (!el) return;
            let html = '';
            for (let i = 0; i < Math.max(typedText.length, expectedWord.length); i++) {
                if (i < typedText.length && i < expectedWord.length) {
                    html += typedText[i] === expectedWord[i]
                        ? `<span class="char correct-char">${typedText[i]}</span>`
                        : `<span class="char incorrect-char">${typedText[i]}</span>`;
                } else if (i < typedText.length) {
                    html += `<span class="char extra-char">${typedText[i]}</span>`;
                } else if (i < expectedWord.length) {
                    html += `<span class="char expected-char">${expectedWord[i]}</span>`;
                }
            }
            el.innerHTML = html;
        }

        function normalizeWord(s) { return (s || '').toLowerCase().replace(/[^a-z0-9]+/gi, ''); }
        function compareWordChars(typed, expected) {
            const a = (typed || '').toLowerCase();
            const b = (expected || '').toLowerCase();
            let matches = 0;
            let incorrect = 0;
            const L = Math.min(a.length, b.length);
            for (let i = 0; i < L; i++) {
                if (a[i] === b[i]) matches++; else incorrect++;
            }
            const extra = Math.max(0, a.length - b.length);
            const missed = Math.max(0, b.length - a.length);
            return { matches, incorrect, extra, missed };
        }

        function updateCursorPosition() {
            const cursor = document.getElementById('cursorIndicator');
            const el = document.querySelector(`[data-index="${currentWordIndex}"]`);
            if (!el) return;
            const rect = el.getBoundingClientRect();
            const area = document.getElementById('textArea').getBoundingClientRect();
            const inputLength = hiddenInput.value.length;
            const charWidth = rect.width / Math.max(1, el.textContent.length);
            const x = rect.left - area.left + (inputLength * charWidth);
            const y = rect.top - area.top;
            cursor.style.left = x + 'px';
            cursor.style.top = y + 'px';
            cursor.style.display = 'block';
        }

        function updateTimer() {
            if (!testActive || !startTime) return;
            const elapsed = (Date.now() - startTime) / 1000;
            const remaining = Math.max(0, testDuration - elapsed);
            document.getElementById('timeRemaining').textContent = formatTime(remaining);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function setTestDuration(d) { testDuration = d; }
        function updateTimeOptions() {
            timeOptions.forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.duration) === testDuration);
            });
        }

        // Events
        textArea.addEventListener('click', () => { if (!testActive) startTest(); hiddenInput.focus(); });
        hiddenInput.addEventListener('focus', () => { if (testActive) updateCursorPosition(); });
        hiddenInput.addEventListener('blur', () => { document.getElementById('cursorIndicator').style.display = 'none'; });
        hiddenInput.addEventListener('input', (e) => {
            if (!testActive) return;
            const input = e.target.value;
            const currentWord = words[currentWordIndex];
            if (input && input.includes(' ')) {
                const parts = input.split(' ');
                parts.forEach(w => { if (w.trim()) processWord(w.trim()); });
                e.target.value = '';
                updateCursorPosition();
            } else if (input) {
                updateCurrentWordDisplay(input, currentWord);
                updateCursorPosition();
            }
        });
        hiddenInput.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && e.shiftKey) { e.preventDefault(); restartTest(); }
            else if (e.key === 'Enter' && e.ctrlKey && e.shiftKey) { e.preventDefault(); newTest(); }
        });
        newTestBtn.addEventListener('click', newTest);
        restartBtn.addEventListener('click', restartTest);
        document.getElementById('backBtn').addEventListener('click', () => { window.location.href = 'index.html'; });
        timeOptions.forEach(opt => opt.addEventListener('click', function(){ setTestDuration(parseInt(this.dataset.duration)); updateTimeOptions(); if (testActive) newTest(); }));

        function newTest() {
            document.getElementById('testCompleteModal').style.display = 'none';
            document.getElementById('cursorIndicator').style.display = 'none';
            testActive = false; startTime = null; currentWordIndex = 0; typedWords = []; incorrectWords = []; grossCharsTyped = 0; accCorrectChars = 0; accTotalChars = 0; totalWordsTyped = 0; correctWordsTyped = 0;
            document.getElementById('timeRemaining').textContent = formatTime(testDuration);
            startTest();
        }

        function restartTest() {
            document.getElementById('testCompleteModal').style.display = 'none';
            document.getElementById('cursorIndicator').style.display = 'none';
            testActive = false; startTime = null; currentWordIndex = 0; typedWords = []; incorrectWords = []; grossCharsTyped = 0; accCorrectChars = 0; accTotalChars = 0; totalWordsTyped = 0; correctWordsTyped = 0;
            document.getElementById('timeRemaining').textContent = formatTime(testDuration);
            hiddenInput.value = '';
            pickText();
        }

        // Initialize
        updateTimeOptions();
        pickText();
    });
    </script>
</body>
</html>

