<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORANGUTYPE</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1 class="app-title">ORANGUTYPE</h1>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="text-area" id="textArea">
                <div class="text-content" id="textContent">
                    <!-- Text will be populated by Python backend -->
                </div>
            </div>

            <!-- Test Complete Modal -->
            <div class="modal" id="testCompleteModal" style="display: none;">
                <div class="modal-content">
                    <h2 class="modal-title">TEST COMPLETE!</h2>
                    <div class="results-grid">
                        <div class="result-column">
                            <div class="result-item">
                                <span class="result-label">WPM</span>
                                <span class="result-value" id="resultWpm">0</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">ACCURACY</span>
                                <span class="result-value" id="resultAccuracy">0%</span>
                            </div>
                        </div>
                        <div class="result-column">
                            <div class="result-item">
                                <span class="result-label">TIME ELAPSED:</span>
                                <span class="result-value" id="resultTime">0:00</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">WORDS TYPED:</span>
                                <span class="result-value" id="resultWords">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="instructions">
                TAB + ENTER - RESTART TEST
            </div>
        </div>

        <!-- Footer Control Panel -->
        <div class="footer">
            <div class="control-row">
                <div class="time-remaining">
                    <span class="label">TIME REMAINING:</span>
                    <span class="time-value" id="timeRemaining">10:00</span>
                </div>
                <div class="language-selector">
                    <div class="language-icon">Aa</div>
                    <span class="language-text">ENGLISH</span>
                </div>
            </div>
            
            <div class="control-row">
                <div class="feature-toggles">
                    <span class="toggle-item"># PUNCTUATIONS</span>
                    <span class="toggle-item">$ NUMBERS</span>
                </div>
                
                <div class="separator"></div>
                
                <div class="time-options">
                    <span class="time-option" data-duration="15">15</span>
                    <span class="time-option" data-duration="30">30</span>
                    <span class="time-option" data-duration="60">60</span>
                    <span class="time-option" data-duration="120">120</span>
                </div>
                
                <div class="separator"></div>
                
                <div class="action-buttons">
                    <button class="action-btn" id="newTestBtn">NEW TEST</button>
                    <button class="action-btn" id="restartBtn">RESTART</button>
                </div>
            </div>
        </div>

        <!-- Hidden Input Field -->
        <input type="text" id="hiddenInput" class="hidden-input" autocomplete="off" spellcheck="false">
        
        <!-- Cursor Indicator -->
        <div class="cursor-indicator" id="cursorIndicator"></div>
    </div>

    <script>
        // Simple event handling without external libraries
        document.addEventListener('DOMContentLoaded', function() {
            const hiddenInput = document.getElementById('hiddenInput');
            const textArea = document.getElementById('textArea');
            const newTestBtn = document.getElementById('newTestBtn');
            const restartBtn = document.getElementById('restartBtn');
            const timeOptions = document.querySelectorAll('.time-option');
            
            let currentTestData = null;
            let testActive = false;
            let startTime = null;
            let testDuration = 60; // Default 60 seconds
            let currentWordIndex = 0;
            let typedWords = [];
            let incorrectWords = [];
            
            // Focus input when clicking on text area
            textArea.addEventListener('click', function() {
                if (!testActive) {
                    startTest();
                }
                hiddenInput.focus();
            });
            
            // Handle input focus/blur for cursor visibility
            hiddenInput.addEventListener('focus', function() {
                if (testActive) {
                    updateCursorPosition();
                }
            });
            
            hiddenInput.addEventListener('blur', function() {
                document.getElementById('cursorIndicator').style.display = 'none';
            });
            
            // Handle input
            hiddenInput.addEventListener('input', function(e) {
                if (!testActive) return;
                
                const input = e.target.value;
                const currentWord = currentTestData.words[currentWordIndex];
                
                if (input && input.includes(' ')) {
                    // Word completed
                    const words = input.split(' ');
                    words.forEach(word => {
                        if (word.trim()) {
                            processWord(word.trim());
                        }
                    });
                    e.target.value = '';
                    updateCursorPosition();
                } else if (input) {
                    // Character by character typing
                    updateCurrentWordDisplay(input, currentWord);
                    updateCursorPosition();
                }
            });
            
            // Handle key events
            hiddenInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && e.shiftKey) {
                    e.preventDefault();
                    restartTest();
                } else if (e.key === 'Enter' && e.ctrlKey && e.shiftKey) {
                    e.preventDefault();
                    newTest();
                }
            });
            
            // Button event handlers
            newTestBtn.addEventListener('click', newTest);
            restartBtn.addEventListener('click', restartTest);
            
            // Time option handlers
            timeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const duration = parseInt(this.dataset.duration);
                    setTestDuration(duration);
                    updateTimeOptions();
                    if (testActive) {
                        newTest();
                    }
                });
            });
            
            function startTest() {
                if (testActive) return;
                
                testActive = true;
                startTime = Date.now();
                currentWordIndex = 0;
                typedWords = [];
                incorrectWords = [];
                
                // Request new text from backend
                fetch('/api/new_test')
                    .then(response => response.json())
                    .then(data => {
                        currentTestData = data;
                        displayText(data.text);
                        hiddenInput.focus();
                        updateCursorPosition();
                    });
                
                // Start timer
                updateTimer();
                const timerInterval = setInterval(updateTimer, 1000);
                
                // Check for test end
                const testEndInterval = setInterval(() => {
                    if (Date.now() - startTime >= testDuration * 1000) {
                        clearInterval(timerInterval);
                        clearInterval(testEndInterval);
                        endTest();
                    }
                }, 1000);
            }
            
            function endTest() {
                testActive = false;
                const elapsed = (Date.now() - startTime) / 1000;
                
                // Hide cursor
                document.getElementById('cursorIndicator').style.display = 'none';
                
                // Calculate results
                const wpm = Math.round((typedWords.length / elapsed) * 60);
                const accuracy = currentWordIndex > 0 ? 
                    Math.round(((currentWordIndex - incorrectWords.length) / currentWordIndex) * 100) : 100;
                
                // Display results
                document.getElementById('resultWpm').textContent = wpm;
                document.getElementById('resultAccuracy').textContent = accuracy + '%';
                document.getElementById('resultTime').textContent = formatTime(elapsed);
                document.getElementById('resultWords').textContent = typedWords.length;
                
                document.getElementById('testCompleteModal').style.display = 'flex';
            }
            
            function processWord(word) {
                if (!testActive || !currentTestData) return;
                
                typedWords.push(word);
                
                const expectedWord = currentTestData.words[currentWordIndex];
                const isCorrect = word === expectedWord;
                
                if (!isCorrect) {
                    incorrectWords.push({
                        expected: expectedWord,
                        typed: word,
                        position: currentWordIndex
                    });
                }
                
                // Mark the word as correct or incorrect
                const wordElement = document.querySelector(`[data-index="${currentWordIndex}"]`);
                if (wordElement) {
                    wordElement.classList.remove('current');
                    if (isCorrect) {
                        wordElement.classList.add('correct');
                    } else {
                        wordElement.classList.add('incorrect');
                    }
                }
                
                currentWordIndex++;
                
                // Check if we need more text
                if (currentWordIndex >= currentTestData.words.length) {
                    fetch('/api/more_text')
                        .then(response => response.json())
                        .then(data => {
                            currentTestData = data;
                            displayText(data.text);
                            currentWordIndex = 0;
                        });
                }
                
                updateDisplay();
            }
            
            function displayText(text) {
                const textContent = document.getElementById('textContent');
                textContent.innerHTML = '';
                
                const words = text.split(' ');
                words.forEach((word, index) => {
                    const wordSpan = document.createElement('span');
                    wordSpan.textContent = word + ' ';
                    wordSpan.className = 'word';
                    wordSpan.dataset.index = index;
                    textContent.appendChild(wordSpan);
                });
                
                // Update display after loading new text
                updateDisplay();
            }
            
            function updateDisplay() {
                // Update word highlighting
                const words = document.querySelectorAll('.word');
                words.forEach((word, index) => {
                    // Reset classes but keep correct/incorrect status
                    const isCorrect = word.classList.contains('correct');
                    const isIncorrect = word.classList.contains('incorrect');
                    
                    word.className = 'word';
                    
                    if (index < currentWordIndex) {
                        // Keep correct/incorrect status for completed words
                        if (isCorrect) {
                            word.classList.add('correct');
                        } else if (isIncorrect) {
                            word.classList.add('incorrect');
                        }
                    } else if (index === currentWordIndex) {
                        word.classList.add('current');
                    }
                });
            }
            
            function updateCurrentWordDisplay(typedText, expectedWord) {
                if (!expectedWord) return;
                
                const currentWordElement = document.querySelector(`[data-index="${currentWordIndex}"]`);
                if (!currentWordElement) return;
                
                // Create character-by-character display
                let displayHTML = '';
                for (let i = 0; i < Math.max(typedText.length, expectedWord.length); i++) {
                    if (i < typedText.length && i < expectedWord.length) {
                        if (typedText[i] === expectedWord[i]) {
                            displayHTML += `<span class="char correct-char">${typedText[i]}</span>`;
                        } else {
                            displayHTML += `<span class="char incorrect-char">${typedText[i]}</span>`;
                        }
                    } else if (i < typedText.length) {
                        displayHTML += `<span class="char extra-char">${typedText[i]}</span>`;
                    } else if (i < expectedWord.length) {
                        displayHTML += `<span class="char expected-char">${expectedWord[i]}</span>`;
                    }
                }
                
                currentWordElement.innerHTML = displayHTML;
            }
            
            function updateCursorPosition() {
                const cursorIndicator = document.getElementById('cursorIndicator');
                const currentWordElement = document.querySelector(`[data-index="${currentWordIndex}"]`);
                const hiddenInput = document.getElementById('hiddenInput');
                
                if (!currentWordElement || !hiddenInput) return;
                
                const rect = currentWordElement.getBoundingClientRect();
                const textAreaRect = document.getElementById('textArea').getBoundingClientRect();
                
                // Calculate cursor position based on input length
                const inputLength = hiddenInput.value.length;
                const charWidth = rect.width / currentWordElement.textContent.length;
                const cursorX = rect.left - textAreaRect.left + (inputLength * charWidth);
                const cursorY = rect.top - textAreaRect.top;
                
                cursorIndicator.style.left = cursorX + 'px';
                cursorIndicator.style.top = cursorY + 'px';
                cursorIndicator.style.display = 'block';
            }
            
            function updateTimer() {
                if (!testActive || !startTime) return;
                
                const elapsed = (Date.now() - startTime) / 1000;
                const remaining = Math.max(0, testDuration - elapsed);
                document.getElementById('timeRemaining').textContent = formatTime(remaining);
            }
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            function setTestDuration(duration) {
                testDuration = duration;
            }
            
            function updateTimeOptions() {
                timeOptions.forEach(option => {
                    option.classList.remove('active');
                    if (parseInt(option.dataset.duration) === testDuration) {
                        option.classList.add('active');
                    }
                });
            }
            
            function newTest() {
                document.getElementById('testCompleteModal').style.display = 'none';
                document.getElementById('cursorIndicator').style.display = 'none';
                testActive = false;
                startTime = null;
                currentWordIndex = 0;
                typedWords = [];
                incorrectWords = [];
                document.getElementById('timeRemaining').textContent = formatTime(testDuration);
                startTest();
            }
            
            function restartTest() {
                document.getElementById('testCompleteModal').style.display = 'none';
                document.getElementById('cursorIndicator').style.display = 'none';
                testActive = false;
                startTime = null;
                currentWordIndex = 0;
                typedWords = [];
                incorrectWords = [];
                document.getElementById('timeRemaining').textContent = formatTime(testDuration);
                hiddenInput.value = '';
                displayText(currentTestData ? currentTestData.text : '');
            }
            
            // Initialize
            updateTimeOptions();
            fetch('/api/new_test')
                .then(response => response.json())
                .then(data => {
                    currentTestData = data;
                    displayText(data.text);
                });
        });
    </script>
</body>
</html>
